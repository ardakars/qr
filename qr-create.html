<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Toplu QR ve Mail Hazırlama</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; margin: 0; }
    button { font-size: 1em; padding: 5px 10px; margin: 5px; border-radius: 6px; border: 1px solid #ccc; cursor: pointer; }
    .qr-container { margin: 15px auto; width: 420px; text-align: center; border: 1px solid #ddd; padding: 10px; border-radius: 8px; display: inline-block; }
    .qr-container p { margin: 10px 0 0 0; font-weight: bold; font-size: 1.2em; word-wrap: break-word; }
    @media (max-width: 480px) {
      .qr-container { width: 90%; max-width: 420px; margin-bottom: 15px; }
    }
  </style>
</head>
<body>
  <h2>Toplu QR ve Mail Hazırlama</h2>
  <button id="generateBtn" disabled>Tüm QR’ları Üret</button>
  <button id="downloadAllBtn" disabled>Tüm QR’ları ZIP olarak indir</button>

  <div id="qrList"></div>

  <script>
    let names = [];
    let emails = [];
    let qrCanvases = [];

    fetch('names.txt')
      .then(res => res.text())
      .then(text => {
        const lines = text.split('\n').map(l => l.trim()).filter(l => l.length>0);
        lines.forEach(line => {
          const parts = line.split(';');
          const name = parts[0].trim();
          const email = parts[1] ? parts[1].trim() : '';
          names.push(name);
          emails.push(email);
        });
        document.getElementById('generateBtn').disabled = false;
      });

    function generateAllQR() {
      const qrListDiv = document.getElementById("qrList");
      qrListDiv.innerHTML = "";
      qrCanvases = [];

      names.forEach((name, idx) => {
        const email = emails[idx];

        const container = document.createElement("div");
        container.className = "qr-container";

        const qrDiv = document.createElement("div");
        container.appendChild(qrDiv);

        const p = document.createElement("p");
        p.textContent = name;
        container.appendChild(p);

        const qr = new QRCode(qrDiv, {
          text: encodeURIComponent(name),
          width: 400,
          height: 400,
          correctLevel: QRCode.CorrectLevel.H
        });

        // PNG İndir butonu
        const downloadBtn = document.createElement("button");
        downloadBtn.textContent = "PNG İndir";
        downloadBtn.onclick = () => {
          const img = qrDiv.querySelector('img') || qrDiv.querySelector('canvas');
          let url;
          if(img.tagName === 'IMG') {
            url = img.src;
          } else {
            url = img.toDataURL("image/png");
          }
          const a = document.createElement('a');
          a.href = url;
          a.download = name.replace(/\s+/g,'_') + '.png';
          a.click();
        };
        container.appendChild(downloadBtn);

        // Mail Aç butonu
        if(email) {
          const mailBtn = document.createElement("button");
          mailBtn.textContent = "Mail Aç";
          mailBtn.onclick = () => {
            const subject = encodeURIComponent("QR Kodunuz");
            const body = encodeURIComponent(`Merhaba ${name},\nLütfen indirdiğiniz QR kodunu mailinize ekleyin.`);
            window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
          };
          container.appendChild(mailBtn);
        }

        qrListDiv.appendChild(container);

        // Canvas veya img kaydet
        setTimeout(() => { // QRCode kütüphanesi biraz zaman alıyor
          const imgOrCanvas = qrDiv.querySelector('img') || qrDiv.querySelector('canvas');
          qrCanvases.push({name: name.replace(/\s+/g,'_'), el: imgOrCanvas});
          document.getElementById('downloadAllBtn').disabled = false;
        }, 100);
      });
    }

    document.getElementById('generateBtn').addEventListener('click', generateAllQR);

    document.getElementById('downloadAllBtn').addEventListener('click', () => {
      const zip = new JSZip();
      qrCanvases.forEach(item => {
        let dataURL;
        if(item.el.tagName === 'IMG') {
          dataURL = item.el.src;
        } else {
          dataURL = item.el.toDataURL("image/png");
        }
        const base64 = dataURL.split(',')[1];
        zip.file(item.name + '.png', base64, {base64: true});
      });
      zip.generateAsync({type:"blob"}).then(function(content) {
        saveAs(content, "QR_Codes.zip");
      });
    });
  </script>
</body>
</html>
